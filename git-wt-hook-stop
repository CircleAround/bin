#!/usr/bin/env bash
# git-wt-hook-stop - Claude Code Stop hook for git-wt
# Called when Claude finishes responding (waiting for user input)
set -euo pipefail

# Check if current directory is a git-wt managed worktree
is_git_wt_worktree() {
  [[ "$PWD" =~ \.worktrees/[1-9](/|$) ]]
}

# Exit silently if not in a git-wt worktree
if ! is_git_wt_worktree; then
  exit 0
fi

# Read JSON input from stdin
input=$(cat)

# Extract transcript_path from JSON
transcript_path=""
if command -v jq &>/dev/null; then
  transcript_path=$(echo "$input" | jq -r '.transcript_path // empty' 2>/dev/null) || true
else
  transcript_path=$(echo "$input" | grep -o '"transcript_path": *"[^"]*"' | sed 's/"transcript_path": *"\(.*\)"/\1/' | head -1) || true
fi

# Find git-wt command
GIT_WT=""
if command -v git-wt &>/dev/null; then
  GIT_WT="git-wt"
elif [[ -x "$HOME/bin/git-wt" ]]; then
  GIT_WT="$HOME/bin/git-wt"
elif [[ -x "$HOME/CircleAround/bin/git-wt" ]]; then
  GIT_WT="$HOME/CircleAround/bin/git-wt"
fi

[[ -z "$GIT_WT" ]] && exit 0

# Mark as waiting
"$GIT_WT" waiting >/dev/null 2>&1 || true

# Extract Claude's last message from transcript
if [[ -n "$transcript_path" && -f "$transcript_path" ]]; then
  claude_message=""
  if command -v jq &>/dev/null; then
    claude_message=$(grep '"type":"assistant"' "$transcript_path" 2>/dev/null | tail -1 | jq -r '.message.content[0].text // empty' 2>/dev/null) || true
  fi

  # Save Claude's message if found (truncate to first line, max 100 chars)
  if [[ -n "$claude_message" ]]; then
    # Get first line only
    first_line=$(echo "$claude_message" | head -1)
    # Truncate to 100 chars
    truncated="${first_line:0:100}"
    [[ ${#first_line} -gt 100 ]] && truncated="${truncated}..."

    "$GIT_WT" claude-msg "$truncated" >/dev/null 2>&1 || true
  fi
fi

exit 0
