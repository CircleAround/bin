#!/usr/bin/env bash
# git-wt  â”€ create worktree at ../<repo>.worktrees/<branch>
set -euo pipefail

usage() { echo "Usage: git-wt [branch]"; exit 1; }
[[ ${1-} =~ ^(-h|--help)$ ]] && usage

# â‘  Git ãƒªãƒã‚¸ãƒˆãƒªã‹ç¢ºèª
git rev-parse --is-inside-work-tree &>/dev/null || {
  echo "âŒ ã“ã“ã¯ Git ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2; exit 1; }

# â‘¡ ãƒ–ãƒ©ãƒ³ãƒåï¼ˆæœªæŒ‡å®šãªã‚‰èãï¼‰
branch="${1-}"
[[ -z $branch ]] && read -rp "ä½œæˆã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒå: " branch
[[ -z $branch ]] && { echo "âŒ ãƒ–ãƒ©ãƒ³ãƒåãŒç©ºã§ã™"; exit 1; }

# â‘¢ ãƒ‘ã‚¹è¨ˆç®—
root="$(git rev-parse --show-toplevel)"
repo="$(basename "$root")"
wroot="$root/../${repo}.worktrees"

# â‘£ æ¬¡ã®åˆ©ç”¨å¯èƒ½ãªç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
next_num=1
while [[ -e "$wroot/$next_num" ]]; do
  ((next_num++))
done
target="$wroot/$next_num"

mkdir -p "$wroot"

# â‘¤ ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°è¿½è·¡ã€ç„¡ã‘ã‚Œã°æ–°è¦
if git show-ref --verify --quiet "refs/heads/$branch"; then
  git worktree add "$target" "$branch"
elif git ls-remote --exit-code --heads origin "$branch" &>/dev/null; then
  git worktree add "$target" "origin/$branch"
else
  git worktree add -b "$branch" "$target"
fi

echo "âœ… Worktree ä½œæˆ: $target (ãƒ–ãƒ©ãƒ³ãƒ: $branch)"
git worktree list

# â‘¥ ç§»å‹•ç”¨ã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤º
echo ""
echo "ğŸ“ æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã™ã‚‹ã«ã¯:"
echo "cd \"$target\""

