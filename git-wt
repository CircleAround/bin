#!/usr/bin/env bash
# git-wt  ─ create worktree at ../<repo>.worktrees/<branch>
set -euo pipefail

usage() { echo "Usage: git-wt [branch]"; exit 1; }
[[ ${1-} =~ ^(-h|--help)$ ]] && usage

# ① Git リポジトリか確認
git rev-parse --is-inside-work-tree &>/dev/null || {
  echo "❌ ここは Git リポジトリではありません" >&2; exit 1; }

# ② ブランチ名（未指定なら聞く）
branch="${1-}"
[[ -z $branch ]] && read -rp "作成するブランチ名: " branch
[[ -z $branch ]] && { echo "❌ ブランチ名が空です"; exit 1; }

# ③ パス計算
root="$(git rev-parse --show-toplevel)"
repo="$(basename "$root")"
wroot="$root/../${repo}.worktrees"

# ④ 次の利用可能な番号を見つける
next_num=1
while [[ -e "$wroot/$next_num" ]]; do
  ((next_num++))
done
target="$wroot/$next_num"

mkdir -p "$wroot"

# ⑤ リモートにブランチがあれば追跡、無ければ新規
if git show-ref --verify --quiet "refs/heads/$branch"; then
  git worktree add "$target" "$branch"
elif git ls-remote --exit-code --heads origin "$branch" &>/dev/null; then
  git worktree add "$target" "origin/$branch"
else
  git worktree add -b "$branch" "$target"
fi

echo "✅ Worktree 作成: $target (ブランチ: $branch)"
git worktree list

# ⑥ 移動用コマンドを表示
echo ""
echo "📁 新しいディレクトリに移動するには:"
echo "cd \"$target\""

