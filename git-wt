#!/usr/bin/env bash
# git-wt  â”€ manage worktrees at ../<repo>.worktrees/<number>
set -euo pipefail

usage() {
  cat << 'EOF'
Usage: git-wt [command] [args]

Commands:
  git-wt add <branch>  Create worktree with branch
  git-wt pop [num]     Remove worktree by number (defaults to highest)

Examples:
  git-wt add feature-x  Create worktree in directory "1" with branch "feature-x"
  git-wt pop            Remove highest numbered worktree
  git-wt pop 2          Remove worktree directory "2"
EOF
  exit 1
}

# â‘  Git ãƒªãƒã‚¸ãƒˆãƒªã‹ç¢ºèª
git rev-parse --is-inside-work-tree &>/dev/null || {
  echo "âŒ ã“ã“ã¯ Git ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2; exit 1; }

# â‘¡ ãƒ‘ã‚¹è¨ˆç®—ï¼ˆå…±é€šï¼‰
root="$(git rev-parse --show-toplevel)"
repo="$(basename "$root")"
wroot="$root/../${repo}.worktrees"

# â‘¢ ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
command="${1-}"
case "$command" in
  -h|--help) usage ;;
  pop)
    shift
    # pop ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†
    target_num="${1-}"
    
    # worktree ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    [[ -d "$wroot" ]] || { echo "âŒ worktree ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: $wroot"; exit 1; }
    
    # ç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€æœ€å¤§ç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
    if [[ -z "$target_num" ]]; then
      max_num=0
      for dir in "$wroot"/*; do
        [[ -d "$dir" ]] || continue
        num=$(basename "$dir")
        [[ "$num" =~ ^[0-9]+$ ]] && ((num > max_num)) && max_num=$num
      done
      [[ $max_num -eq 0 ]] && { echo "âŒ å‰Šé™¤å¯èƒ½ãª worktree ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; exit 1; }
      target_num=$max_num
    fi
    
    target="$wroot/$target_num"
    [[ -d "$target" ]] || { echo "âŒ worktree ãŒå­˜åœ¨ã—ã¾ã›ã‚“: $target"; exit 1; }
    
    # worktree ã‚’å‰Šé™¤
    git worktree remove "$target"
    echo "âœ… Worktree å‰Šé™¤: $target"
    git worktree list
    ;;
  add)
    shift
    # add ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†
    branch="${1-}"
    [[ -z "$branch" ]] && { echo "âŒ ãƒ–ãƒ©ãƒ³ãƒåã‚’æŒ‡å®šã—ã¦ãã ã•ã„: git-wt add <branch>"; exit 1; }
    
    # æ¬¡ã®åˆ©ç”¨å¯èƒ½ãªç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
    next_num=1
    while [[ -e "$wroot/$next_num" ]]; do
      ((next_num++))
    done
    target="$wroot/$next_num"
    
    mkdir -p "$wroot"
    
    # ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°è¿½è·¡ã€ç„¡ã‘ã‚Œã°æ–°è¦
    if git show-ref --verify --quiet "refs/heads/$branch"; then
      git worktree add "$target" "$branch"
    elif git ls-remote --exit-code --heads origin "$branch" &>/dev/null; then
      git worktree add "$target" "origin/$branch"
    else
      git worktree add -b "$branch" "$target"
    fi
    
    echo "âœ… Worktree ä½œæˆ: $target (ãƒ–ãƒ©ãƒ³ãƒ: $branch)"
    git worktree list
    
    # ç§»å‹•ç”¨ã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤º
    echo ""
    echo "ğŸ“ æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã™ã‚‹ã«ã¯:"
    echo "cd \"$target\""
    ;;
  "")
    # å¼•æ•°ãªã—ï¼šé¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    echo "ã‚³ãƒãƒ³ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„:"
    echo "1. add - æ–°ã—ã„worktreeã‚’ä½œæˆ"
    echo "2. pop - æ—¢å­˜ã®worktreeã‚’å‰Šé™¤"
    echo ""
    read -rp "é¸æŠ [1-2]: " choice
    
    case "$choice" in
      1)
        read -rp "ãƒ–ãƒ©ãƒ³ãƒåã‚’å…¥åŠ›: " branch
        [[ -z "$branch" ]] && { echo "âŒ ãƒ–ãƒ©ãƒ³ãƒåãŒç©ºã§ã™"; exit 1; }
        
        # æ¬¡ã®åˆ©ç”¨å¯èƒ½ãªç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
        next_num=1
        while [[ -e "$wroot/$next_num" ]]; do
          ((next_num++))
        done
        target="$wroot/$next_num"
        
        mkdir -p "$wroot"
        
        # ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°è¿½è·¡ã€ç„¡ã‘ã‚Œã°æ–°è¦
        if git show-ref --verify --quiet "refs/heads/$branch"; then
          git worktree add "$target" "$branch"
        elif git ls-remote --exit-code --heads origin "$branch" &>/dev/null; then
          git worktree add "$target" "origin/$branch"
        else
          git worktree add -b "$branch" "$target"
        fi
        
        echo "âœ… Worktree ä½œæˆ: $target (ãƒ–ãƒ©ãƒ³ãƒ: $branch)"
        git worktree list
        
        # ç§»å‹•ç”¨ã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤º
        echo ""
        echo "ğŸ“ æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã™ã‚‹ã«ã¯:"
        echo "cd \"$target\""
        ;;
      2)
        # worktree ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        [[ -d "$wroot" ]] || { echo "âŒ worktree ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: $wroot"; exit 1; }
        
        # æœ€å¤§ç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
        max_num=0
        for dir in "$wroot"/*; do
          [[ -d "$dir" ]] || continue
          num=$(basename "$dir")
          [[ "$num" =~ ^[0-9]+$ ]] && ((num > max_num)) && max_num=$num
        done
        [[ $max_num -eq 0 ]] && { echo "âŒ å‰Šé™¤å¯èƒ½ãª worktree ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; exit 1; }
        
        target="$wroot/$max_num"
        git worktree remove "$target"
        echo "âœ… Worktree å‰Šé™¤: $target"
        git worktree list
        ;;
      *)
        echo "âŒ ç„¡åŠ¹ãªé¸æŠã§ã™"
        exit 1
        ;;
    esac
    ;;
  *)
    # ä¸æ˜ãªã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰
    echo "âŒ ä¸æ˜ãªã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰: $command"
    usage
    ;;
esac

